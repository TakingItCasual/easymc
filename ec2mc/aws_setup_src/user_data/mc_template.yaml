# Comments are lost on YAML loading, so an intermediate entry is needed
shebang: "#cloud-config"

# Other setup info for template (removed once processed)
ec2mc_template_info:
  AMI_info:
    AMI_name: amzn2-ami-hvm-2.0.20180810-x86_64-gp2
    default_user: ec2-user
  instance_type: t2.small
  volume_size: 8
  security_groups:
  - minecraft_sg
  ip_handler: mc_handler.py
  write_directories:
  - local_dir: manage_scripts
    instance_dir: /home/ec2-user/manage-scripts/
    chmod: "0775"

# add security patches and bug fixes
repo_update: true
repo_upgrade: all

# If you need certain packages installed
packages:
- screen
- java-1.8.0

# Files copied from user_data template subdirectory(s) to write_files

# Commands to run on instance's first boot
runcmd:
- whoami
- su ec2-user <<'EOF' # Run following commands as ec2-user
- whoami
- sudo crontab < /home/ec2-user/manage-scripts/mc_crontab.txt
- [ sudo, curl, "https://launcher.mojang.com/v1/objects/\
  fe123682e9cb30031eae351764f653500b7396c9/server.jar",
  --create-dirs, -o, /home/ec2-user/minecraft/server.1.13.1.jar ]
- sudo /home/ec2-user/manage-scripts/start_server.sh &
- wait $!
- sudo sed -i 's/eula=false/eula=true/g' /home/ec2-user/minecraft/eula.txt
- sudo /home/ec2-user/manage-scripts/startup_script.sh
- EOF
- whoami

# Reboot instance after completing setup
power_state:
  mode: reboot
  message: Rebooting
  timeout: 120

# Capture all subprocess output into logfile (for debugging)
output: { all: "| tee -a /var/log/cloud-init-output.log" }
